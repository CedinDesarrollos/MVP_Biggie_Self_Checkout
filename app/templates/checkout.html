{% extends 'base.html' %}
{% block title %}Checkout{% endblock %}

{% block head_extra %}
<style>
  #qr-area {
    max-width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    margin: 0 auto;
  }

  #reader {
    width: 100%;
    max-width: 350px;
    aspect-ratio: 1 / 1;
    margin: 0 auto;
  }

  #scan-result {
    margin-top: 1rem;
  }

  .btn-scan {
    width: 100%;
    font-size: 1rem;
    padding: 0.75rem;
  }

  .btn-stop {
    background-color: #fff;
    color: var(--color-rojo);
    border: 2px solid var(--color-rojo);
  }

  .btn-stop:hover {
    background-color: #f8d7da;
  }

  /* Animación y posición del mensaje agregado */
  #product-added-backdrop {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(4px);
    display: none;
    z-index: 9998;
  }

  #product-added {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
    font-weight: bold;
    font-size: 1.5rem;
    padding: 1.2rem 2rem;
    background-color: white;
    border: 2px solid var(--color-rojo);
    border-radius: 12px;
    color: var(--color-rojo);
    text-align: center;
    max-width: 90%;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

  #product-added.show {
    opacity: 1;
  }


</style>
{% endblock %}

{% block content %}
<div class="mt-4">
  <!-- Mensaje flotante -->
  <div id="product-added-backdrop"></div>
    <div id="product-added" class="d-none">
        📦<br><strong><span id="product-name">...</span></strong><br>agregado al carrito
  </div>

  <div class="text-center mb-4">
    <h5 class="fw-bold text-uppercase mb-1" style="letter-spacing: 1px;">
      <i class="bi bi-upc-scan me-2"></i> Escaneá el producto
    </h5>
    <div style="height: 4px; width: 60px; background-color: var(--color-rojo); margin: 0 auto; border-radius: 2px;"></div>
  </div>

  <div id="qr-area" class="mb-3 position-relative" style="height: 300px;">
    <div id="barcode-placeholder"
         class="d-flex justify-content-center align-items-center"
         style="position: absolute; inset: 0; z-index: 1;">
      <i class="bi bi-upc-scan"
         style="font-size: 120px; color: #6c757d; opacity: 0.6;"></i>
    </div>
    <div id="reader" style="width: 100%; height: 100%;"></div>
  </div>

  <div class="d-grid gap-2">
    <button id="btn-start" class="btn btn-rojo btn-scan">Iniciar escaneo</button>
    <button id="btn-stop" class="btn btn-stop btn-scan d-none">Detener escaneo</button>
  </div>

  <div id="scan-result" class="alert alert-info d-none text-center">Esperando escaneo...</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='libs/html5-qrcode.min.js') }}"></script>
<script>
  let html5Qr;
  let scanning = false;

  const startButton = document.getElementById("btn-start");
  const stopButton = document.getElementById("btn-stop");
  const resultBox = document.getElementById("scan-result");

  function obtenerNombreProducto(codigo) {
    const mockProductos = {
      "123456789": "Coca-Cola 500ml",
      "987654321": "Pepsi Light 1L",
      "111222333": "Yerba Mate Kurupí"
    };
    return mockProductos[codigo] || `Producto ${codigo}`;
  }

  function mostrarAlertaProducto(nombreProducto) {
    const alerta = document.getElementById("product-added");
    const backdrop = document.getElementById("product-added-backdrop");
    const spanNombre = document.getElementById("product-name");

    spanNombre.textContent = nombreProducto;

    alerta.classList.remove("d-none");
    backdrop.style.display = "block";
    setTimeout(() => alerta.classList.add("show"), 10);  // activar animación

    setTimeout(() => {
        alerta.classList.remove("show");
        setTimeout(() => {
        alerta.classList.add("d-none");
        backdrop.style.display = "none";
        }, 400);
    }, 2000);
  }

  function onScanSuccess(decodedText, decodedResult) {
    resultBox.textContent = `Código escaneado: ${decodedText}`;
    resultBox.classList.remove("d-none");

    const nombreProducto = obtenerNombreProducto(decodedText);
    mostrarAlertaProducto(nombreProducto);
  }

  function startScan() {
    document.getElementById("barcode-placeholder").style.display = "none";
    document.getElementById("barcode-placeholder").style.visibility = "hidden";
    html5Qr = new Html5Qrcode("reader");
    html5Qr.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: function(viewfinderWidth, viewfinderHeight) {
          const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
          return { width: minEdge * 0.75, height: minEdge * 0.95 };
        }
      },
      onScanSuccess
    );

    scanning = true;
    startButton.classList.add("d-none");
    stopButton.classList.remove("d-none");
    resultBox.textContent = "Escaneando...";
    resultBox.classList.remove("d-none");
  }

  function stopScan() {
    document.getElementById("barcode-placeholder").style.display = "flex";
    document.getElementById("barcode-placeholder").style.visibility = "visible";
    if (scanning && html5Qr) {
      html5Qr.stop().then(() => {
        scanning = false;
        startButton.classList.remove("d-none");
        stopButton.classList.add("d-none");
      });
    }
  }

  startButton.addEventListener("click", startScan);
  stopButton.addEventListener("click", stopScan);
</script>
{% endblock %}
